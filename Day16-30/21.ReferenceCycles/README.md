# Day 21: å¼•ç”¨å¾ªç¯ä¸å†…å­˜æ³„æ¼ (Reference Cycles)

## ğŸ“ å­¦ä¹ ç›®æ ‡

- ç†è§£ **å¼•ç”¨å¾ªç¯ (Reference Cycle)** æ˜¯å¦‚ä½•äº§ç”Ÿçš„
- æŒæ¡ **å†…å­˜æ³„æ¼ (Memory Leak)** çš„åŸå› 
- ç†Ÿç»ƒä½¿ç”¨ **`Weak<T>`** (å¼±å¼•ç”¨) æ‰“ç ´å¾ªç¯
- èƒ½å¤Ÿæ„å»ºçˆ¶å­åŒå‘å¼•ç”¨çš„ **æ ‘å½¢ç»“æ„**

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šRc çš„é˜¿å–€ç‰æ–¯ä¹‹è¸µ

Rust çš„å†…å­˜å®‰å…¨æœºåˆ¶éå¸¸å¼ºå¤§ï¼Œä½†å®ƒå¹¶ä¸ä¿è¯ **ç»å¯¹æ²¡æœ‰å†…å­˜æ³„æ¼**ã€‚
å½“ä½¿ç”¨ `Rc<T>` å’Œ `RefCell<T>` æ—¶ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨ï¼Œä¸”éƒ½æ˜¯å¼ºå¼•ç”¨ (Strong Reference)ï¼Œå°±ä¼šå½¢æˆæ­»é”èˆ¬çš„å¼•ç”¨å¾ªç¯ï¼Œå¯¼è‡´å†…å­˜æ°¸è¿œæ— æ³•é‡Šæ”¾ã€‚

### å¼•ç”¨å¾ªç¯å¯è§†åŒ–

```mermaid
graph LR
    A[èŠ‚ç‚¹ A <br> count: 2] -->|Rc| B[èŠ‚ç‚¹ B <br> count: 2]
    B -->|Rc| A
    
    style A fill:#ffcccc
    style B fill:#ffcccc
```

1. A æŒ‡å‘ Bï¼ŒB çš„è®¡æ•°ä¸º 1ã€‚
2. B æŒ‡å‘ Aï¼ŒA çš„è®¡æ•°ä¸º 1ã€‚
3. å¤–éƒ¨å˜é‡ `a` æŒ‡å‘ Aï¼ŒA è®¡æ•° 2ã€‚
4. å¤–éƒ¨å˜é‡ `b` æŒ‡å‘ Bï¼ŒB è®¡æ•° 2ã€‚
5. `main` ç»“æŸï¼Œ`a` å’Œ `b` ç¦»å¼€ä½œç”¨åŸŸï¼ŒA å’Œ B è®¡æ•°å„å‡ 1ï¼Œå˜ä¸º 1ã€‚
6. **ç»“æœ**ï¼šA å’Œ B äº’ç›¸å¼•ç”¨ï¼Œè®¡æ•°æ°¸è¿œä¸º 1ï¼Œæ°¸è¿œä¸ä¼šè¢«å›æ”¶ï¼

---

## ğŸ›¡ï¸ è§£å†³æ–¹æ¡ˆï¼šWeak<T>

ä¸ºäº†æ‰“ç ´å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ "ä¸æŒæœ‰æ‰€æœ‰æƒ" çš„å¼•ç”¨ï¼Œè¿™å°±æ˜¯ **`Weak<T>`**ã€‚

### å¼ºå¼•ç”¨ vs å¼±å¼•ç”¨

| ç‰¹æ€§ | `Rc<T>` (å¼ºå¼•ç”¨) | `Weak<T>` (å¼±å¼•ç”¨) |
| :--- | :--- | :--- |
| **å¢åŠ è®¡æ•°** | `strong_count` | `weak_count` |
| **æ‰€æœ‰æƒ** | æ‹¥æœ‰æ•°æ® | **ä¸**æ‹¥æœ‰æ•°æ® |
| **ç”Ÿå‘½å‘¨æœŸ** | è®¡æ•°å½’é›¶æ‰æ¸…ç† | ä¸å½±å“æ¸…ç† |
| **è®¿é—®æ–¹å¼** | ç›´æ¥è®¿é—® | å¿…é¡»è°ƒç”¨ `upgrade()` |
| **æ¯”å–»** | ç‰µç€æ°”çƒçš„çº¿ (çº¿åœ¨çƒåœ¨) | çœ‹ç€æ°”çƒçš„äºº (äººèµ°çƒä¸ä¸€å®šèµ°) |

### è®¿é—®å¼±å¼•ç”¨

å› ä¸º `Weak<T>` æŒ‡å‘çš„å€¼å¯èƒ½å·²ç»è¢«é‡Šæ”¾äº†ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å‰å¿…é¡»é€šè¿‡ `.upgrade()` å‡çº§ã€‚å®ƒè¿”å› `Option<Rc<T>>`ã€‚

```rust
use std::rc::{Rc, Weak};

let weak: Weak<i32> = ...;

match weak.upgrade() {
    Some(rc_val) => println!("å€¼è¿˜åœ¨: {}", rc_val),
    None => println!("å€¼å·²ç»è¢«é‡Šæ”¾äº†"),
}
```

---

## ğŸ’» ä»£ç å®æˆ˜ï¼šæ ‘å½¢ç»“æ„

æœ€ç»å…¸çš„å¼•ç”¨å¾ªç¯åœºæ™¯æ˜¯ **æ ‘ (Tree)**ï¼šçˆ¶èŠ‚ç‚¹æ‹¥æœ‰å­èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹ä¹Ÿæƒ³çŸ¥é“çˆ¶èŠ‚ç‚¹æ˜¯è°ã€‚

- Parent -> Child: **Strong** (çˆ¶åœ¨å­åœ¨)
- Child -> Parent: **Weak** (å­åœ¨çˆ¶ä¸ä¸€å®šåœ¨ï¼Œé˜²æ­¢å¾ªç¯)

```mermaid
graph TD
    Parent[Parent] -->|Rc| Child[Child]
    Child -.->|Weak| Parent
    
    style Parent fill:#ccffcc
    style Child fill:#e1f5fe
```

```rust
use std::rc::{Rc, Weak};
use std::cell::RefCell;

#[derive(Debug)]
struct Node {
    value: i32,
    // å­èŠ‚ç‚¹åˆ—è¡¨ï¼šçˆ¶èŠ‚ç‚¹æ‹¥æœ‰å­èŠ‚ç‚¹ (Vec<Rc>)
    children: RefCell<Vec<Rc<Node>>>,
    // çˆ¶èŠ‚ç‚¹æŒ‡é’ˆï¼šå­èŠ‚ç‚¹å¼±å¼•ç”¨çˆ¶èŠ‚ç‚¹ (Weak)
    parent: RefCell<Weak<Node>>, 
}

fn main() {
    // 1. åˆ›å»ºå¶å­ (Leaf)
    let leaf = Rc::new(Node {
        value: 3,
        parent: RefCell::new(Weak::new()), // åˆå§‹æ²¡æœ‰çˆ¶èŠ‚ç‚¹
        children: RefCell::new(vec![]),
    });

    println!("leaf strong = {}, weak = {}", Rc::strong_count(&leaf), Rc::weak_count(&leaf));

    {
        // 2. åˆ›å»ºæ ‘æ (Branch)
        let branch = Rc::new(Node {
            value: 5,
            children: RefCell::new(vec![Rc::clone(&leaf)]), // Branch æ‹¥æœ‰ Leaf
            parent: RefCell::new(Weak::new()),
        });

        // 3. å»ºç«‹åå‘è¿æ¥ï¼šLeaf æŒ‡å‘ Branch
        *leaf.parent.borrow_mut() = Rc::downgrade(&branch); // è¿™é‡Œä½¿ç”¨ downgrade åˆ›å»º Weak

        println!("branch strong = {}, weak = {}", Rc::strong_count(&branch), Rc::weak_count(&branch));
        
        // å°è¯•è®¿é—®çˆ¶èŠ‚ç‚¹
        println!("leaf parent: {:?}", leaf.parent.borrow().upgrade());
    } // branch ç¦»å¼€ä½œç”¨åŸŸï¼Œè¢«é”€æ¯

    // 4. branch æ­»åï¼Œleaf è¿˜åœ¨ï¼Œä½†å®ƒçš„ parent å·²ç»ç©ºäº†
    println!("leaf parent dead: {:?}", leaf.parent.borrow().upgrade());
}
```

---

## ğŸ‹ï¸ ç»ƒä¹ é¢˜

ğŸ‘‰ **[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç»ƒä¹ é¢˜](./exercises/README.md)**

1. **åˆ¶é€ æ³„æ¼**: æ•…æ„ç¼–å†™ä¸€ä¸ªåŒå‘é“¾è¡¨ A <-> B (ä½¿ç”¨ `Rc`)ï¼Œå¹¶éªŒè¯å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ (strong_count ä¸å½’é›¶)ã€‚
2. **ä¿®å¤æ³„æ¼**: ä½¿ç”¨ `Weak` ä¿®å¤ä¸Šè¿°ä»£ç ã€‚
3. **å›¾ç»“æ„**: å®ç°ä¸€ä¸ªç®€å•çš„æœ‰å‘å›¾ï¼ŒèŠ‚ç‚¹é—´å¯èƒ½æœ‰ç¯ï¼Œæ€è€ƒå¦‚æœåªç”¨ `Rc` ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å±‚çº§å…³ç³»**: åœ¨çˆ¶å­å±‚çº§å…³ç³»ä¸­ï¼Œé€šå¸¸ **çˆ¶æŒå­(Strong)ï¼Œå­æŒ‡çˆ¶(Weak)**ã€‚
2. **æ£€æŸ¥å¿…è¦æ€§**: åªæœ‰åœ¨ç¡®å®éœ€è¦åŒå‘å¼•ç”¨æ—¶æ‰å¼•å…¥ `Weak`ï¼Œå¦åˆ™å•å‘å¼•ç”¨ï¼ˆåªæœ‰ `children`ï¼‰é€šå¸¸æ›´ç®€å•å®‰å…¨ã€‚
3. **Upgrade æ£€æŸ¥**: æ°¸è¿œä¸è¦å‡è®¾ `Weak` æŒ‡é’ˆæœ‰æ•ˆï¼Œå§‹ç»ˆå¤„ç† `upgrade()` è¿”å› `None` çš„æƒ…å†µã€‚

---

## â­ï¸ ä¸‹ä¸€æ­¥

æ™ºèƒ½æŒ‡é’ˆåŠå…¶æ½œåœ¨çš„å†…å­˜é—®é¢˜æˆ‘ä»¬å·²ç»è®¨è®ºå®Œäº†ã€‚
æ¥ä¸‹æ¥çš„è¯é¢˜å°†è¿›å…¥ Rust çš„å¦ä¸€ä¸ªæ€æ‰‹çº§ç‰¹æ€§ï¼š**å¹¶å‘ç¼–ç¨‹**ã€‚
æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å®‰å…¨åœ°ä½¿ç”¨çº¿ç¨‹ï¼Œæ‹¥æŠ±â€œFearless Concurrencyâ€ã€‚

ä¸‹ä¸€èŠ‚: [Day 22: çº¿ç¨‹ (Threads)](../22.Threads/README.md)
