# Day 22: å¹¶å‘ç¼–ç¨‹ - çº¿ç¨‹ (Threads)

## ğŸ“ å­¦ä¹ ç›®æ ‡

- ç†è§£ **1:1 çº¿ç¨‹æ¨¡å‹** ä¸ OS çº¿ç¨‹çš„å…³ç³»
- æŒæ¡ **`thread::spawn`** åˆ›å»ºçº¿ç¨‹ä¸ **`join`** ç­‰å¾…
- æ·±åˆ»ç†è§£ **`move`** é—­åŒ…åœ¨å¤šçº¿ç¨‹æ‰€æœ‰æƒè½¬ç§»ä¸­çš„ä½œç”¨
- æŒæ¡ **`thread::scope`** (Scoped Threads) â€”â€” å€Ÿç”¨å±€éƒ¨å˜é‡çš„ç¥å™¨
- å­¦ä¼šä½¿ç”¨ **Builder** æ¨¡å¼é…ç½®çº¿ç¨‹ï¼ˆå¦‚å‘½åã€æ ˆå¤§å°ï¼‰

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šFearless Concurrency

Rust çš„å¹¶å‘ç¼–ç¨‹è¢«ç§°ä¸º "æ— ç•å¹¶å‘" (Fearless Concurrency)ã€‚
è¿™æ„å‘³ç€è®¸å¤šåœ¨å…¶ä»–è¯­è¨€ä¸­ä¼šå¯¼è‡´è¿è¡Œæ—¶å´©æºƒæˆ–æ•°æ®ç«äº‰çš„é”™è¯¯ï¼ˆå¦‚å¤šçº¿ç¨‹åŒæ—¶è¯»å†™æ— é”å†…å­˜ï¼‰ï¼Œåœ¨ Rust ä¸­æ˜¯ **ç¼–è¯‘æ—¶é”™è¯¯**ã€‚

### çº¿ç¨‹æ¨¡å‹ Gantt å›¾

```mermaid
gantt
    title å¹¶è¡Œæ‰§è¡Œç¤ºæ„å›¾
    dateFormat X
    axisFormat %s
    
    section ä¸»çº¿ç¨‹
    Spawn T1       : 0, 1
    Do Work        : 1, 3
    Join T1        : 3, 5
    
    section å­çº¿ç¨‹ T1
    Start          : 1, 1
    Heavy Task     : 1, 4
    End            : 4, 4
```

ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹æ˜¯ **åŒæ—¶ (Parallel)** è¿è¡Œçš„ï¼Œç›´åˆ°ä¸»çº¿ç¨‹è°ƒç”¨ `.join()` ç­‰å¾…å­çº¿ç¨‹ç»“æŸã€‚

---

## ğŸ› ï¸ åŸºæœ¬ä½¿ç”¨

### 1. `thread::spawn`ä¸ `join`

æœ€åŸºç¡€çš„ç”¨æ³•ã€‚æ³¨æ„ `spawn` è¿”å›ä¸€ä¸ª `JoinHandle`ã€‚

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("hi number {} from the spawned thread!", i);
            thread::sleep(Duration::from_millis(1));
        }
    }); // çº¿ç¨‹åœ¨è¿™é‡Œå¼€å§‹è¿è¡Œ

    for i in 1..5 {
        println!("hi number {} from the main thread!", i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap(); // é˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°å­çº¿ç¨‹ç»“æŸ
}
```

### 2. `move` é—­åŒ…ï¼šæ‰€æœ‰æƒè½¬ç§»

é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹é—­åŒ…ä¸èƒ½å€Ÿç”¨å¤–éƒ¨ç¯å¢ƒçš„å˜é‡ï¼ˆå› ä¸ºç¼–è¯‘å™¨æ— æ³•ä¿è¯å¤–éƒ¨å˜é‡æ´»å¾—æ¯”çº¿ç¨‹ä¹…ï¼‰ã€‚
å¿…é¡»ä½¿ç”¨ `move` å¼ºåˆ¶è½¬ç§»æ‰€æœ‰æƒã€‚

```mermaid
graph LR
    StackMain[ä¸»çº¿ç¨‹æ ˆ: v] --move--> StackThread[å­çº¿ç¨‹æ ˆ: v]
    
    style StackMain fill:#ccffcc
    style StackThread fill:#ffcccc
```

```rust
let v = vec![1, 2, 3];

// âŒ ç¼–è¯‘é”™è¯¯ï¼šv å¯èƒ½åœ¨çº¿ç¨‹ç»“æŸå‰è¢«é‡Šæ”¾
// thread::spawn(|| println!("{:?}", v));

// âœ… æ­£ç¡®ï¼šæŠŠ v çš„æ‰€æœ‰æƒç§»äº¤ç»™çº¿ç¨‹
thread::spawn(move || println!("{:?}", v));
```

---

## ğŸ”¥ ç°ä»£åˆ©å™¨ï¼šScoped Threads (`thread::scope`)

åœ¨ Rust 1.63 ä¹‹å‰ï¼Œæƒ³åœ¨çº¿ç¨‹é‡Œ **å€Ÿç”¨** (è€Œä¸æ˜¯ move) å±€éƒ¨å˜é‡éå¸¸éº»çƒ¦ï¼ˆé€šå¸¸è¦ç”¨ `Arc`ï¼‰ã€‚
ç°åœ¨æˆ‘ä»¬æœ‰äº† `std::thread::scope`ã€‚å®ƒä¿è¯åœ¨ä½œç”¨åŸŸç»“æŸå‰ï¼Œé‡Œé¢åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¢« joinã€‚

**è¿™å°±æ˜¯æ‰€è°“çš„ "Scoped Threads"ï¼šç¼–è¯‘å™¨çŸ¥é“è¿™äº›çº¿ç¨‹ç»ä¸ä¼šæ´»å¾—æ¯”ä½œç”¨åŸŸä¹…ï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°å€Ÿç”¨å±€éƒ¨å˜é‡ï¼**

```rust
use std::thread;

fn main() {
    let v = vec![1, 2, 3]; // å±€éƒ¨å˜é‡

    thread::scope(|s| {
        // å€Ÿç”¨ vï¼Œä¸éœ€è¦ moveï¼
        s.spawn(|| {
            println!("Thread 1: {:?}", v); 
        });

        s.spawn(|| {
            println!("Thread 2: len = {}", v.len());
        });
    }); // <--- è¿™é‡Œä¼šéšå¼ join æ‰€æœ‰çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ä¼šåœ¨è¿™é‡Œé˜»å¡ç­‰å¾…

    println!("All threads finished, v is still here: {:?}", v);
}
```

---

## âš™ï¸ è¿›é˜¶é…ç½®ï¼šBuilder API

å¦‚æœä½ éœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼ˆæ¯”å¦‚ç»™çº¿ç¨‹èµ·åå­—ï¼Œæ–¹ä¾¿ Panic æ—¶è°ƒè¯•ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `Builder`ã€‚

```rust
use std::thread;

let handle = thread::Builder::new()
    .name("worker-1".into()) // å‘½åçº¿ç¨‹
    .stack_size(32 * 1024)   // è®¾ç½®æ ˆå¤§å° 32KB
    .spawn(|| {
        println!("I am a customized thread!");
    })
    .unwrap();

handle.join().unwrap();
```

---

## ğŸ‹ï¸ ç»ƒä¹ é¢˜

ğŸ‘‰ **[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ç»ƒä¹ é¢˜](./exercises/README.md)**

1. **åŸºæœ¬çº¿ç¨‹**: åˆ›å»º 10 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªæ‰“å°ä¸€ä¸ªæ•°å­—ã€‚
2. **Scoped Threads**: ä½¿ç”¨ `thread::scope` å¹¶å‘è®¡ç®—åˆ‡ç‰‡çš„ä¸¤åŠéƒ¨åˆ†ä¹‹å’Œã€‚
3. **Move è¯­ä¹‰**: å°è¯•åœ¨ä¸ä½¿ç”¨ `move` çš„æƒ…å†µä¸‹å°† `String` ä¼ å…¥ `spawn` çº¿ç¨‹ï¼Œè§‚å¯ŸæŠ¥é”™ï¼Œå¹¶ä¿®å¤å®ƒã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆç”¨ Scope**: å¦‚æœä½ çš„çº¿ç¨‹ä¸éœ€è¦æ´»å¾—æ¯”å‡½æ•°ä¹…ï¼Œä¼˜å…ˆä½¿ç”¨ `thread::scope`ï¼Œå®ƒæ¯” `Arc` æ›´å¿«ä¸”æ›´æ˜“è¯»ã€‚
2. **é¿å… Detach**: è™½ç„¶å¯ä»¥ä¸è°ƒç”¨ `join` è®©çº¿ç¨‹åå°è¿è¡Œ (Detach)ï¼Œä½†è¿™é€šå¸¸ä¼šå¯¼è‡´èµ„æºéš¾ä»¥ç®¡ç†å’Œç¨‹åºé€€å‡ºæ—¶çš„æœªå®šä¹‰è¡Œä¸ºã€‚
3. **é…ç½®åç§°**: ç»™çº¿ç¨‹èµ·ä¸ªåå­—ï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­å‡ºäº† Bug èƒ½å¿«é€Ÿå®šä½çš„å…³é”®ã€‚

---

## â­ï¸ ä¸‹ä¸€æ­¥

ç°åœ¨æˆ‘ä»¬èƒ½åœ¨çº¿ç¨‹é—´å¹¶è¡Œæ‰§è¡Œä»£ç äº†ï¼Œä½†å¦‚æœçº¿ç¨‹ä¹‹é—´éœ€è¦ **é€šè¿‡å‘æ¶ˆæ¯** æ¥äº¤æµæ€ä¹ˆåŠï¼Ÿï¼ˆGo è¯­è¨€çš„å“²å­¦ï¼šä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼‰ã€‚

ä¸‹ä¸€èŠ‚: [Day 23: æ¶ˆæ¯ä¼ é€’ (Message Passing)](../23.MessagePassing/README.md)
