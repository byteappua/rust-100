# Day 22: å¹¶å‘ç¼–ç¨‹ - çº¿ç¨‹ (Threads)

<p align="center">
  <img src="https://img.shields.io/badge/Difficulty-â­â­â­â­-orange?style=flat-square" alt="Difficulty">
  <img src="https://img.shields.io/badge/Topic-Concurrency-blue?style=flat-square" alt="Topic">
  <img src="https://img.shields.io/badge/Rust-1.75%2B-orange?logo=rust&style=flat-square" alt="Rust">
</p>

Rust ä¸­çš„å¹¶å‘ç¼–ç¨‹éå¸¸å®‰å…¨ï¼Œå› ä¸º Rust çš„æ‰€æœ‰æƒå’Œç±»å‹ç³»ç»Ÿä¼šåœ¨**ç¼–è¯‘æ—¶**æ•è·è®¸å¤šå¹¶å‘é”™è¯¯ï¼ˆå¦‚æ•°æ®ç«äº‰ï¼‰ã€‚è¿™è®© Rust æˆä¸ºç¼–å†™é«˜æ€§èƒ½å¹¶å‘ç¨‹åºçš„ç†æƒ³è¯­è¨€ã€‚

---

## ğŸ“ å­¦ä¹ ç›®æ ‡

- ç†è§£çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
- æŒæ¡ä½¿ç”¨ `std::thread::spawn` åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹
- å­¦ä¼šä½¿ç”¨ `Join Handle` ç­‰å¾…çº¿ç¨‹å®Œæˆ
- ç†è§£ `move` é—­åŒ…åœ¨å¤šçº¿ç¨‹ä¸­çš„ä½œç”¨
- æŒæ¡çº¿ç¨‹å®‰å…¨çš„æ•°æ®ä¼ é€’æ–¹å¼
- äº†è§£çº¿ç¨‹çš„æ€§èƒ½å¼€é”€å’Œä½¿ç”¨åœºæ™¯

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¦å­¦è¿™ä¸ª

å¹¶å‘ç¼–ç¨‹æ˜¯ç°ä»£åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒï¼š

1. **å……åˆ†åˆ©ç”¨ç¡¬ä»¶**ï¼šç°ä»£ CPU éƒ½æ˜¯å¤šæ ¸çš„ï¼Œå•çº¿ç¨‹ç¨‹åºæ— æ³•å……åˆ†åˆ©ç”¨ç¡¬ä»¶æ€§èƒ½
2. **æå‡å“åº”æ€§**ï¼šå°†è€—æ—¶ä»»åŠ¡æ”¾åˆ°åå°çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­å“åº”ç”¨æˆ·
3. **æé«˜ååé‡**ï¼šå¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ï¼ˆå¦‚ Web æœåŠ¡å™¨ï¼‰
4. **Rust çš„ä¼˜åŠ¿**ï¼šç¼–è¯‘æ—¶ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ²¡æœ‰æ•°æ®ç«äº‰ï¼

**ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”**ï¼š

- **C/C++**ï¼šæ€§èƒ½é«˜ä½†å®¹æ˜“å‡ºç°æ•°æ®ç«äº‰ã€æ­»é”ç­‰é—®é¢˜
- **Go**ï¼šgoroutine è½»é‡ä½†è¿è¡Œæ—¶å¼€é”€å¤§
- **Rust**ï¼šé›¶æˆæœ¬æŠ½è±¡ + ç¼–è¯‘æ—¶å®‰å…¨ä¿è¯ = æœ€ä½³é€‰æ‹©ï¼

---

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

### 1. çº¿ç¨‹ vs è¿›ç¨‹

```mermaid
graph TD
    subgraph è¿›ç¨‹A
        T1A[ä¸»çº¿ç¨‹]
        T2A[å­çº¿ç¨‹1]
        T3A[å­çº¿ç¨‹2]
        M1[å†…å­˜ç©ºé—´]
        T1A -.å…±äº«.-> M1
        T2A -.å…±äº«.-> M1
        T3A -.å…±äº«.-> M1
    end
    
    subgraph è¿›ç¨‹B
        T1B[ä¸»çº¿ç¨‹]
        M2[å†…å­˜ç©ºé—´]
        T1B --> M2
    end
    
    style M1 fill:#ccffcc
    style M2 fill:#ffcccc
```

| ç‰¹æ€§ | è¿›ç¨‹ (Process) | çº¿ç¨‹ (Thread) |
|:---|:---|:---|
| **å†…å­˜ç©ºé—´** | ç‹¬ç«‹ | å…±äº«åŒä¸€è¿›ç¨‹çš„å†…å­˜ |
| **å¼€é”€** | é‡ï¼ˆMB çº§ï¼‰ | è½»ï¼ˆKB çº§ï¼‰ |
| **é€šä¿¡** | IPCï¼ˆæ…¢ï¼‰ | å…±äº«å†…å­˜ï¼ˆå¿«ä½†éœ€è¦åŒæ­¥ï¼‰ |
| **å®‰å…¨æ€§** | éš”ç¦»æ€§å¥½ | éœ€è¦æ‰‹åŠ¨ä¿è¯çº¿ç¨‹å®‰å…¨ |

### 2. çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T as å­çº¿ç¨‹
    
    Main->>Main: thread::spawn(é—­åŒ…)
    Main->>T: åˆ›å»ºå­çº¿ç¨‹
    Note over Main,T: ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ
    
    par ä¸»çº¿ç¨‹å·¥ä½œ
        Main->>Main: æ‰§è¡Œä»»åŠ¡...
    and å­çº¿ç¨‹å·¥ä½œ
        T->>T: æ‰§è¡Œé—­åŒ…...
    end
    
    alt ä¸»çº¿ç¨‹å…ˆç»“æŸ
        Main->>T: âŒ å¼ºåˆ¶ç»ˆæ­¢å­çº¿ç¨‹
        Note over T: æœªæ‰§è¡Œå®Œä¹Ÿè¢«ç»ˆæ­¢
    else è°ƒç”¨ join()
        Main->>T: ç­‰å¾…å­çº¿ç¨‹å®Œæˆ
        T-->>Main: âœ… è¿”å›ç»“æœ
    end
```

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºæœ¬çº¿ç¨‹åˆ›å»º

```rust
use std::thread;
use std::time::Duration;

fn main() {
    // åˆ›å»ºå­çº¿ç¨‹
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("ğŸ§µ å­çº¿ç¨‹: number {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    // ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
    for i in 1..5 {
        println!("ğŸš€ ä¸»çº¿ç¨‹: number {}", i);
        thread::sleep(Duration::from_millis(1));
    }

    // ç­‰å¾…å­çº¿ç¨‹å®Œæˆï¼ˆé‡è¦ï¼ï¼‰
    handle.join().unwrap();
    
    println!("âœ… æ‰€æœ‰çº¿ç¨‹å®Œæˆ");
}
```

### ç¤ºä¾‹ 2: move é—­åŒ… - è½¬ç§»æ‰€æœ‰æƒ

```rust
use std::thread;

fn main() {
    let v = vec![1, 2, 3];

    // âœ… ä½¿ç”¨ move å¼ºåˆ¶è½¬ç§»æ‰€æœ‰æƒ
    let handle = thread::spawn(move || {
        println!("ğŸ“¦ vector: {:?}", v);
    });

    handle.join().unwrap();
}
```

### ç¤ºä¾‹ 3: ä½¿ç”¨ JoinHandle è·å–è¿”å›å€¼

```rust
use std::thread;

fn main() {
    let handle = thread::spawn(|| {
        std::thread::sleep(std::time::Duration::from_secs(1));
        42 // è¿”å›è®¡ç®—ç»“æœ
    });

    println!("â³ ç­‰å¾…è®¡ç®—ç»“æœ...");
    let result = handle.join().unwrap();
    println!("âœ¨ è®¡ç®—ç»“æœ: {}", result);
}
```

---

## ğŸ¤” å¸¸è§é—®é¢˜ FAQ

### Q1: Rust çº¿ç¨‹ vs Go goroutine vs C++ threadï¼Ÿ

| ç‰¹æ€§ | Rust std::thread | Go goroutine | C++ std::thread |
|:---|:---|:---|:---|
| **æ¨¡å‹** | 1:1 OS çº¿ç¨‹ | M:N ç»¿è‰²çº¿ç¨‹ | 1:1 OS çº¿ç¨‹ |
| **å¼€é”€** | ~2MB | ~2KB | ~2MB |
| **è°ƒåº¦** | OS è°ƒåº¦ | Go è¿è¡Œæ—¶è°ƒåº¦ | OS è°ƒåº¦ |
| **å®‰å…¨æ€§** | ç¼–è¯‘æ—¶ä¿è¯ | è¿è¡Œæ—¶æ£€æŸ¥ | æ— ä¿è¯ |

### Q2: join() ä¼šé˜»å¡å—ï¼Ÿ

**æ˜¯çš„ï¼** `join()` ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ç›®æ ‡çº¿ç¨‹ç»“æŸã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å§‹ç»ˆjoin()**: ç¡®ä¿å­çº¿ç¨‹å®Œæˆæˆ–ä½¿ç”¨å…¶ä»–åŒæ­¥æœºåˆ¶
2. **çº¿ç¨‹å‘½å**: ä½¿ç”¨ `Builder::new().name()` ä¾¿äºè°ƒè¯•
3. **é¿å…è¿‡åº¦çº¿ç¨‹åŒ–**: çº¿ç¨‹ä¸æ˜¯å…è´¹çš„ï¼Œæ¯ä¸ªçº¦å  2MB æ ˆç©ºé—´

---

## ğŸ”— æ‰©å±•é˜…è¯»

- [Rust Book: Fearless Concurrency](https://doc.rust-lang.org/book/ch16-00-concurrency.html)
- [std::thread æ–‡æ¡£](https://doc.rust-lang.org/std/thread/)

---

## â­ï¸ ä¸‹ä¸€æ­¥

**ä¸‹ä¸€èŠ‚**: [Day 23: æ¶ˆæ¯ä¼ é€’ (Message Passing)](../23.MessagePassing/README.md)
